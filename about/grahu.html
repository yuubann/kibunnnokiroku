<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>統計グラフ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #eef2f7;
      text-align: center;
    }
    input {
      margin: 0.5rem;
      padding: 0.4rem;
    }
    canvas {
      max-width: 700px;
      margin: 2rem auto;
    }
    nav {
      margin-top: 2rem;
      text-align: center;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #007bff;
    }
  </style>
</head>
<body>
  <nav style="margin-top: 2rem; text-align: center;">
    <a href="https://yuubann.github.io/kibunnnokiroku/">入力ページ</a> |
    <a href="https://yuubann.github.io/kibunnnokiroku/about/hyou">記録一覧</a> |
    <a href="https://yuubann.github.io/kibunnnokiroku/about/grahu">統計グラフ</a>
  </nav>
　<br>
  <h1>気分統計グラフ（期間指定）</h1>
  <label>開始日: <input type="date" id="startDate"></label>
  <label>終了日: <input type="date" id="endDate"></label>
  <button onclick="filterAndRender()">更新</button>

  <canvas id="moodChart"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDDnJXHrk8iVNshBKutAtjkMJfPcT9aZ_0",
    authDomain: "kibunnnokiroku.firebaseapp.com",
    databaseURL: "https://kibunnnokiroku-default-rtdb.firebaseio.com",
    projectId: "kibunnnokiroku",
    storageBucket: "kibunnnokiroku.firebasestorage.app",
    messagingSenderId: "385335029995",
    appId: "1:385335029995:web:35728204be94704f350eae",
    measurementId: "G-HRTWT7EHBP"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

let rawLogs = [];

function fetchFromFirebaseAndRender() {
  firebase.database().ref("moodLogs").once("value")
    .then(snapshot => {
      rawLogs = Object.values(snapshot.val() || {});
      filterAndRender();
    })
    .catch(error => {
      console.error("Firebaseからの読み込みに失敗:", error);
      alert("データの読み込みに失敗しました。");
      renderChart([], []); // 空のグラフを表示
    });
}

    function filterAndRender() {
      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);
      end.setHours(23, 59, 59, 999); // include end of day

      const filtered = rawLogs.filter(log => {
        const logDate = new Date(log.date);
        return (!isNaN(start) && !isNaN(end)) ? logDate >= start && logDate <= end : true;
      });

      const moodCounts = {
        'とても良い': 0,
        '良い': 0,
        '普通': 0,
        '悪い': 0,
        'とても悪い': 0
      };

      filtered.forEach(log => {
        if (moodCounts.hasOwnProperty(log.mood)) {
          moodCounts[log.mood]++;
        }
      });

      renderChart(Object.keys(moodCounts), Object.values(moodCounts));
    }

    let chart;

    function renderChart(labels, data) {
      const ctx = document.getElementById('moodChart').getContext('2d');

      if (chart) chart.destroy(); // 再描画のため一度破棄

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '選択回数',
            data,
            backgroundColor: ['#4caf50', '#8bc34a', '#ffc107', '#ff9800', '#f44336']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    // 初期描画（全期間）
    window.onload = () => fetchFromFirebaseAndRender();
  </script>
</body>
</html>
