<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>記録一覧</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f7f9fc;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    nav {
      margin-top: 2rem;
      text-align: center;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #007bff;
    }
  </style>
</head>
<body>
  <h1>記録一覧</h1>
  <nav style="margin-top: 2rem; text-align: center;">
    <a href="https://yuubann.github.io/kibunnnokiroku/">入力ページ</a> |
    <a href="https://yuubann.github.io/kibunnnokiroku/about/hyou">記録一覧</a> |
    <a href="https://yuubann.github.io/kibunnnokiroku/about/grahu">統計グラフ</a>
  </nav>
　<br>
<label for="start-date">開始日:</label>
<input type="date" id="start-date">
<label for="end-date">終了日:</label>
<input type="date" id="end-date">
<button onclick="filterByDateRange()">検索</button>
<button onclick="resetFilter()">リセット</button>
<br><br>
  <table>
    <thead>
      <tr>
        <th>日時</th>
        <th>気分</th>
        <th>大カテゴリ</th>
        <th>中カテゴリ</th>
        <th>メモ</th>
      </tr>
    </thead>
    <tbody id="log-table-body"></tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js"></script>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDDnJXHrk8iVNshBKutAtjkMJfPcT9aZ_0",
    authDomain: "kibunnnokiroku.firebaseapp.com",
    databaseURL: "https://kibunnnokiroku-default-rtdb.firebaseio.com",
    projectId: "kibunnnokiroku",
    storageBucket: "kibunnnokiroku.firebasestorage.app",
    messagingSenderId: "385335029995",
    appId: "1:385335029995:web:35728204be94704f350eae",
    measurementId: "G-HRTWT7EHBP"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

let logs = []; // { key: 'ユニークID', data: {記録内容} } の形式で保存

firebase.database().ref("moodLogs").once("value").then(snapshot => {
    const logsData = snapshot.val() || {};
    logs = []; // 配列を初期化
    snapshot.forEach(childSnapshot => {
        logs.push({
            key: childSnapshot.key, // ← ユニークIDを保持
            data: childSnapshot.val()
        });
    });
    // 日付の降順（新しいものが上）に並び替え
    logs.sort((a, b) => new Date(b.data.date) - new Date(a.data.date));
    renderTable(logs);
});

function renderTable(filteredLogs) {
    tableBody.innerHTML = "";
    filteredLogs.forEach((log, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="datetime-local" value="${formatForInput(log.data.date)}" onchange="updateLog(${index}, 'date', this.value)"></td>
            <td><input value="${log.data.mood}" onchange="updateLog(${index}, 'mood', this.value)"></td>
            <td><input value="${log.data.majorCategory}" onchange="updateLog(${index}, 'majorCategory', this.value)"></td>
            <td><input value="${log.data.middleCategory}" onchange="updateLog(${index}, 'middleCategory', this.value)"></td>
            <td><input value="${log.data.freeText || ""}" onchange="updateLog(${index}, 'freeText', this.value)"></td>
        `;
        tableBody.appendChild(row);
    });
}

function updateLog(index, field, value) {
    const logToUpdate = logs[index]; // 更新対象のログを取得
    const updatedField = { [field]: value };

    // Firebase上の特定のキーを持つデータを更新
    firebase.database().ref("moodLogs/" + logToUpdate.key).update(updatedField)
        .then(() => {
            // ローカルのデータも更新
            logToUpdate.data[field] = value;
            console.log("更新成功:", logToUpdate.key, updatedField);
        })
        .catch(error => {
            console.error("更新失敗:", error);
            alert("データの更新に失敗しました。");
            // 失敗した場合はページをリロードして再同期するなどの対応
            location.reload();
        });
}


// 日付の変換（"2025/08/05 10:12:34" → "2025-08-05T10:12"）
function formatForInput(dateStr) {
  const d = new Date(dateStr);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}

function filterByDateRange() {
  const startDate = document.getElementById("start-date").value;
  const endDate = document.getElementById("end-date").value;

  if (!startDate && !endDate) {
    return renderTable(logs);
    return;
  }

  const filtered = logs.filter(log => {
    const logDate = new Date(log.date);
    const start = startDate ? new Date(startDate) : null;
    const end = endDate ? new Date(endDate) : null;

    if (start && end) {
      return logDate >= start && logDate <= new Date(end.getTime() + 86400000 - 1); // 終了日の23:59:59まで含める
    } else if (start) {
      return logDate >= start;
    } else if (end) {
      return logDate <= new Date(end.getTime() + 86400000 - 1);
    }
    return true;
  });

  renderTable(filtered);
}

function resetFilter() {
  document.getElementById("start-date").value = "";
  document.getElementById("end-date").value = "";
  renderTable(logs);
}

  </script>
</body>
</html>
