<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>記録一覧</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f7f9fc;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    nav {
      margin-top: 2rem;
      text-align: center;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #007bff;
    }
  </style>
</head>
<body>
  <h1>記録一覧</h1>
  <nav style="margin-top: 2rem; text-align: center;">
    <a href="https://yuubann.github.io/kibunnnokiroku/">入力ページ</a> |
    <a href="https://yuubann.github.io/kibunnnokiroku/about/hyou">記録一覧</a> |
    <a href="https://yuubann.github.io/kibunnnokiroku/about/grahu">統計グラフ</a>
  </nav>
　<br>
<label for="start-date">開始日:</label>
<input type="date" id="start-date">
<label for="end-date">終了日:</label>
<input type="date" id="end-date">
<button onclick="filterByDateRange()">検索</button>
<button onclick="resetFilter()">リセット</button>
<br><br>
  <table>
    <thead>
      <tr>
        <th>日時</th>
        <th>気分</th>
        <th>大カテゴリ</th>
        <th>中カテゴリ</th>
        <th>メモ</th>
      </tr>
    </thead>
    <tbody id="log-table-body"></tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "xxxxxx",
    authDomain: "xxxx.firebaseapp.com",
    databaseURL: "https://xxxx.firebaseio.com",
    projectId: "xxxx",
    storageBucket: "xxxx.appspot.com",
    messagingSenderId: "xxx",
    appId: "xxx"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let logs = [];

  const tableBody = document.getElementById("log-table-body");

  function renderTable(filteredLogs) {
    tableBody.innerHTML = "";
    filteredLogs.forEach((log, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="datetime-local" value="${formatForInput(log.date)}" onchange="updateLog(${index}, 'date', this.value)"></td>
        <td><input value="${log.mood}" onchange="updateLog(${index}, 'mood', this.value)"></td>
        <td><input value="${log.majorCategory}" onchange="updateLog(${index}, 'majorCategory', this.value)"></td>
        <td><input value="${log.middleCategory}" onchange="updateLog(${index}, 'middleCategory', this.value)"></td>
        <td><input value="${log.freeText || ""}" onchange="updateLog(${index}, 'freeText', this.value)"></td>
      `;
      tableBody.appendChild(row);
    });
  }

  function updateLog(index, key, value) {
    logs[index][key] = value;
    renderTable(logs); // ローカルの表示を即時更新
　　firebase.database().ref("moodLogs").set(logs);
  }


// 日付の変換（"2025/08/05 10:12:34" → "2025-08-05T10:12"）
function formatForInput(dateStr) {
  const d = new Date(dateStr);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}

function filterByDateRange() {
  const startDate = document.getElementById("start-date").value;
  const endDate = document.getElementById("end-date").value;

  if (!startDate && !endDate) {
    return renderTable(logs);
    return;
  }

  const filtered = logs.filter(log => {
    const logDate = new Date(log.date);
    const start = startDate ? new Date(startDate) : null;
    const end = endDate ? new Date(endDate) : null;

    if (start && end) {
      return logDate >= start && logDate <= new Date(end.getTime() + 86400000 - 1); // 終了日の23:59:59まで含める
    } else if (start) {
      return logDate >= start;
    } else if (end) {
      return logDate <= new Date(end.getTime() + 86400000 - 1);
    }
    return true;
  });

  renderTable(filtered);
}

function resetFilter() {
  document.getElementById("start-date").value = "";
  document.getElementById("end-date").value = "";
  renderTable(logs);
}

  firebase.database().ref("moodLogs").once("value").then(snapshot => {
    logs = Object.values(snapshot.val() || {});
    renderTable(logs);
  });



  </script>
</body>
</html>
